
services:
  nifi:
    image: apache/nifi:latest
    container_name: nifi
    ports:
      - "8088:8080"
      - "8443:8443"
    environment:
      # NiFi Web UI port
      - NIFI_WEB_HTTP_PORT=8080
      - NIFI_WEB_HTTPS_PORT=
      - NIFI_WEB_PROXY_HOST=localhost:8443,127.0.0.1:8443
      # JVM memory settings
      - NIFI_JVM_HEAP_INIT=512m
      - NIFI_JVM_HEAP_MAX=1024m
      # Enable secure communication
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=NiFi123NiFi123!
    volumes:
      # Persist NiFi state across container restarts
      - nifi-state:/opt/nifi/nifi-current/state
      - nifi-content:/opt/nifi/nifi-current/content_repository
      - nifi-database:/opt/nifi/nifi-current/database_repository
      - nifi-flowfile:/opt/nifi/nifi-current/flowfile_repository
      - nifi-provenance:/opt/nifi/nifi-current/provenance_repository
      # Mount logs for easier debugging
      - nifi-logs:/opt/nifi/nifi-current/logs
      # Mount a directory for data input/output
      - ./data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/nifi/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nifi-network
    restart: unless-stopped

  # Optional: Add a database service if needed (e.g., for QueryDatabaseTable processor)
  postgres:
    image: postgres:latest
    container_name: nifi-postgres
    environment:
      - POSTGRES_DB=nifi_db
      - POSTGRES_USER=nifi_user
      - POSTGRES_PASSWORD=nifi_password
    volumes:
      - postgres-data:/var/lib/postgresql
    networks:
      - nifi-network
    restart: unless-stopped

volumes:
  nifi-state:
  nifi-content:
  nifi-database:
  nifi-flowfile:
  nifi-provenance:
  nifi-logs:
  postgres-data:

networks:
  nifi-network:
    driver: bridge